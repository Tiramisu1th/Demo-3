<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Hong Kong Interactive Map with Leaflet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
    </style>
</head>

<body>
    <h1>Hong Kong Interactive Map</h1>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Helper: Calculate distance between two lat/lon points (Haversine formula)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const toRad = deg => deg * Math.PI / 180;
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in meters
        }

        async function initMap() {
            try {
                // 1. Fetch initial center location from Supabase API
                const locResponse = await fetch('https://ovvmyienbhkptqqosooy.supabase.co/rest/v1/LocationHandler', {
                    headers: {
                        'Accept': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dm15aWVuYmhrcHRxcW9zb295Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwODgxNjQsImV4cCI6MjA2NDY2NDE2NH0.xhxVnoCLoOdHPOTstxu1SGYqjsKqI2UVyBaEk0bpNxI'
                    }
                });

                const locData = await locResponse.json();
                const initialLoc = locData[0];

                const initialLat = parseFloat(initialLoc.lat);
                const initialLon = parseFloat(initialLoc.long);

                if (isNaN(initialLat) || isNaN(initialLon)) {
                    throw new Error('Invalid lat/lon values');
                }

                // Initialize map centered at the fetched coordinates
                const map = L.map('map').setView([initialLat, initialLon], 14);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19
                }).addTo(map);

                // Smaller yellow icon for "You are here"
                const yellowIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [25, 41],           // smaller than before
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                // Green and blue icons for community halls
                const greenIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [40, 65],
                    iconAnchor: [20, 65],
                    popupAnchor: [1, -50],
                    shadowSize: [50, 50]
                });

                const blueIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                    iconSize: [40, 65],
                    iconAnchor: [20, 65],
                    popupAnchor: [1, -50],
                    shadowSize: [50, 50]
                });

                // Add "You are here" marker
                const youAreHereMarker = L.marker([initialLat, initialLon], { icon: yellowIcon }).addTo(map);
                const youAreHereTooltip = youAreHereMarker.bindTooltip("你在此 You are here", {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -10],
                    opacity: 0.9
                });
                youAreHereTooltip.openTooltip();

                // Fetch community halls data
                const hallsResponse = await fetch('https://api.csdi.gov.hk/apim/dataquery/api/?id=had_rcd_1635393119641_62162&layer=bffchcc&limit=500&offset=0');
                if (!hallsResponse.ok) throw new Error('Failed to fetch community hall data');

                const hallData = await hallsResponse.json();
                const features = hallData.features || [];

                const points = features.map(f => {
                    const coords = f.geometry.coordinates; // [lon, lat]
                    const props = f.properties;

                    const lat = coords[1];
                    const lon = coords[0];
                    const dist = getDistance(initialLat, initialLon, lat, lon);

                    return {
                        lat,
                        lon,
                        地點: props['地點'] || '未知地點',
                        Venue: props['Venue'] || 'Unknown Venue',
                        distance: dist
                    };
                });

                points.sort((a, b) => a.distance - b.distance);

                points.forEach((p, index) => {
                    const icon = index < 3 ? greenIcon : blueIcon;
                    const label = `${p.地點} ${p.Venue}`;

                    const marker = L.marker([p.lat, p.lon], { icon }).addTo(map);

                    marker.bindPopup(label);

                    // Tooltips for green and yellow pins open initially, then behave normally
                    if (index < 3) {
                        // Green pins: show tooltip initially
                        const tooltip = marker.bindTooltip(label, {
                            permanent: false,
                            direction: 'top',
                            offset: [0, -10],
                            opacity: 0.9,
                            sticky: true
                        });
                        tooltip.openTooltip();

                        // Open on mouseover, close on mouseout
                        marker.on('mouseover', () => tooltip.openTooltip());
                        marker.on('mouseout', () => tooltip.closeTooltip());
                    } else {
                        // Blue pins: only show tooltip on hover
                        marker.bindTooltip(label, {
                            permanent: false,
                            direction: 'top',
                            offset: [0, -10],
                            opacity: 0.9,
                            sticky: true
                        });
                    }
                });

            } catch (error) {
                console.error('Error initializing map:', error);
                alert('Failed to load map data. See console for details.');
            }
        }

        initMap();
    </script>
</body>

</html>
